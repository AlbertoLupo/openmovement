<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OMAPI: verify.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><a href="http://code.google.com/p/openmovement/"><img border=0 alt="Logo" src="logo.png"/></a></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OMAPI
   &#160;<span id="projectnumber">1.4</span>
   </div>
   <div id="projectbrief">Open Movement Public API</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('verify_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">verify.c</div>  </div>
</div>
<div class="contents">
<a href="verify_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* </span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2009-2012, Newcastle University, UK.</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment"> * </span>
<a name="l00005"></a>00005 <span class="comment"> * Redistribution and use in source and binary forms, with or without </span>
<a name="l00006"></a>00006 <span class="comment"> * modification, are permitted provided that the following conditions are met: </span>
<a name="l00007"></a>00007 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice, </span>
<a name="l00008"></a>00008 <span class="comment"> *    this list of conditions and the following disclaimer.</span>
<a name="l00009"></a>00009 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice, </span>
<a name="l00010"></a>00010 <span class="comment"> *    this list of conditions and the following disclaimer in the documentation </span>
<a name="l00011"></a>00011 <span class="comment"> *    and/or other materials provided with the distribution.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; </span>
<a name="l00014"></a>00014 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="l00015"></a>00015 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
<a name="l00016"></a>00016 <span class="comment"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE </span>
<a name="l00017"></a>00017 <span class="comment"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
<a name="l00018"></a>00018 <span class="comment"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
<a name="l00019"></a>00019 <span class="comment"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span>
<a name="l00020"></a>00020 <span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN </span>
<a name="l00021"></a>00021 <span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) </span>
<a name="l00022"></a>00022 <span class="comment"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE </span>
<a name="l00023"></a>00023 <span class="comment"> * POSSIBILITY OF SUCH DAMAGE. </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00041"></a>00041 <span class="comment">/* Headers */</span>
<a name="l00042"></a>00042 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#define _CRT_SECURE_NO_WARNINGS</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#define gmtime_r(timer, result) gmtime_s(result, timer)</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#define timegm _mkgmtime</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;sys/timeb.h&gt;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">/* API header */</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="omapi_8h.html" title="Open Movement API.">omapi.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">/* Error measures */</span>
<a name="l00062"></a><a class="code" href="verify_8c.html#a080ac2194de86d8acfc23706d1c7d9de">00062</a> <span class="preprocessor">#define STUCK_COUNT (5 * 120)</span>
<a name="l00063"></a><a class="code" href="verify_8c.html#a489b573f8657cc4a892f86b80c1aa608">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define AVERAGE_FACTOR 0.00001</span>
<a name="l00064"></a><a class="code" href="verify_8c.html#a487b6057583dc10b18e976efacbe9edd">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define AVERAGE_RANGE_MAX 0.400</span>
<a name="l00065"></a><a class="code" href="verify_8c.html#ac5b01ce406ab803b55eb603ed5416aff">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define AVERAGE_RANGE_OFF 0.300</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">// Calculate the time in ticks from a packed time</span>
<a name="l00069"></a><a class="code" href="verify_8c.html#a28dd9d5ca8831cc4ddec9b135aba4505">00069</a> time_t <a class="code" href="verify_8c.html#a28dd9d5ca8831cc4ddec9b135aba4505">TimeSerial</a>(<a class="code" href="group__datetime.html#ga5ae96407571b49c6086be47907389dfc" title="A single integer value is used to pack the date/time for a simpler, cross-language, API.">OM_DATETIME</a> timestamp)
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071     time_t tSec;                            <span class="comment">// Seconds since epoch</span>
<a name="l00072"></a>00072     <span class="keyword">struct </span>tm tParts = {0};                 <span class="comment">// Time elements (YMDHMS)</span>
<a name="l00073"></a>00073     tParts.tm_year = <a class="code" href="group__datetime.html#ga3889bada708d70fdae157d910771230b" title="Extract the year from a packed date/time value.">OM_DATETIME_YEAR</a>(timestamp) - 1900;
<a name="l00074"></a>00074     tParts.tm_mon = <a class="code" href="group__datetime.html#gaf4d3426bec2f1ac9dbce0965c7f6f7c8" title="Extract the month (1-12) from a packed date/time value.">OM_DATETIME_MONTH</a>(timestamp) - 1;
<a name="l00075"></a>00075     tParts.tm_mday = <a class="code" href="group__datetime.html#ga09d645a3f7989b65fcc9e9c045c8798a" title="Extract the day (1-31) from a packed date/time value.">OM_DATETIME_DAY</a>(timestamp);
<a name="l00076"></a>00076     tParts.tm_hour = <a class="code" href="group__datetime.html#gae5d26861be6dc34e6f369496a8f87252" title="Extract the hours (0-23) from a packed date/time value.">OM_DATETIME_HOURS</a>(timestamp);
<a name="l00077"></a>00077     tParts.tm_min = <a class="code" href="group__datetime.html#ga6fd03816bcc340df126d7e77f02a7233" title="Extract the minutes (0-59) from a packed date/time value.">OM_DATETIME_MINUTES</a>(timestamp);
<a name="l00078"></a>00078     tParts.tm_sec = <a class="code" href="group__datetime.html#gaf89fa3e164311c43b62cf12297a38dbd" title="Extract the seconds (0-59) from a packed date/time value.">OM_DATETIME_SECONDS</a>(timestamp);
<a name="l00079"></a>00079     tSec = timegm(&amp;tParts);                 <span class="comment">// Pack from YMDHMS</span>
<a name="l00080"></a>00080     <span class="keywordflow">return</span> tSec;
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="comment">// Calculate the time in ticks from a packed time</span>
<a name="l00085"></a><a class="code" href="verify_8c.html#ae705da34ceec812b223d4777b6b5088d">00085</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <a class="code" href="verify_8c.html#ae705da34ceec812b223d4777b6b5088d">Ticks</a>(<a class="code" href="group__datetime.html#ga5ae96407571b49c6086be47907389dfc" title="A single integer value is used to pack the date/time for a simpler, cross-language, API.">OM_DATETIME</a> timestamp, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> fractional)
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087     time_t tSec = <a class="code" href="verify_8c.html#a28dd9d5ca8831cc4ddec9b135aba4505">TimeSerial</a>(timestamp);
<a name="l00088"></a>00088     <span class="keywordflow">return</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)tSec &lt;&lt; 16) + fractional;
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">/* Conversion function */</span>
<a name="l00094"></a><a class="code" href="verify_8c.html#ad5ad9d8ff8c4d00cbffdca435d4c5071">00094</a> <span class="keywordtype">int</span> <a class="code" href="verify_8c.html#ad5ad9d8ff8c4d00cbffdca435d4c5071">verify</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *infile, <span class="keywordtype">char</span> output)
<a name="l00095"></a>00095 {
<a name="l00096"></a>00096     <a class="code" href="group__reader.html#gaa654dad2b5e252a2e9dbce771f50445e" title="Handle to a reader object.">OmReaderHandle</a> reader;
<a name="l00097"></a>00097     <span class="keywordtype">int</span> batteryStartPercent = 0, batteryEndPercent = 0;
<a name="l00098"></a>00098     <span class="keywordtype">int</span> batteryMaxPercent = -1, batteryMinPercent = -1;
<a name="l00099"></a>00099     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> veryFirstTime = 0;                   <span class="comment">// First time in file</span>
<a name="l00100"></a>00100     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> firstTime = 0, lastTime = 0;         <span class="comment">// First &amp; last time in current recording block</span>
<a name="l00101"></a>00101     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> blockStart = 0;
<a name="l00102"></a>00102     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> previousBlockEnd = 0;
<a name="l00103"></a>00103     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> minLight = 0xffff;
<a name="l00104"></a>00104     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> previousSequenceId = -1;
<a name="l00105"></a>00105     <span class="keywordtype">int</span> block;
<a name="l00106"></a>00106     <span class="keywordtype">int</span> day = 0;
<a name="l00107"></a>00107     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totalSamples = 0;
<a name="l00108"></a>00108     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> errorFile = 0, errorEvent = 0, errorStuck = 0, errorRange = 0, errorBreaks = 0, errorRate = 0;
<a name="l00109"></a>00109     <span class="keywordtype">double</span> maxAv = 0.0, peakAv = 0.0;
<a name="l00110"></a>00110     <span class="keywordtype">char</span> first = 1;
<a name="l00111"></a>00111     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> minInterval = 0, maxInterval = 0;
<a name="l00112"></a>00112     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> lastBlockStart = 0;
<a name="l00113"></a>00113     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalDuration = 0;
<a name="l00114"></a>00114     <span class="keywordtype">float</span> breakTime = 0.0f;
<a name="l00115"></a>00115     <span class="keywordtype">int</span> firstPacket;
<a name="l00116"></a>00116     <span class="keywordtype">int</span> lastSecond;
<a name="l00117"></a>00117     <span class="keywordtype">int</span> restarts = 0;
<a name="l00118"></a>00118     <a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html" title="Internal structure of a binary file header block.">OM_READER_HEADER_PACKET</a> *hp;
<a name="l00119"></a>00119     <span class="keywordtype">char</span> outOfRange = 0;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     fprintf(stderr, <span class="stringliteral">&quot;FILE: %s\n&quot;</span>, infile);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <span class="comment">/* Open the binary file reader on the input file */</span>
<a name="l00124"></a>00124     reader = <a class="code" href="group__reader.html#gafe29bdb2bf78d31ae1f75f7bc0ac542d" title="Opens a binary data file for reading.">OmReaderOpen</a>(infile);
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (reader == NULL)
<a name="l00126"></a>00126     {
<a name="l00127"></a>00127         fprintf(stderr, <span class="stringliteral">&quot;ERROR: Problem opening file: %s\n&quot;</span>, infile);
<a name="l00128"></a>00128         <span class="keywordflow">return</span> -1;
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="comment">/* Iterate over all of the blocks of the file */</span>
<a name="l00132"></a>00132     firstPacket = 1;
<a name="l00133"></a>00133     lastSecond = -1;
<a name="l00134"></a>00134     <span class="keywordflow">for</span> (block = 0; ; block++)
<a name="l00135"></a>00135     {
<a name="l00136"></a>00136         <a class="code" href="struct_o_m___r_e_a_d_e_r___d_a_t_a___p_a_c_k_e_t.html" title="Internal structure of a binary file data block.">OM_READER_DATA_PACKET</a> *dp;
<a name="l00137"></a>00137         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> interval;
<a name="l00138"></a>00138         <span class="keywordtype">int</span> numSamples;
<a name="l00139"></a>00139         <span class="keywordtype">short</span> *buffer;
<a name="l00140"></a>00140         <span class="keywordtype">int</span> i;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         <span class="comment">/* Report progress: minute */</span>
<a name="l00143"></a>00143         <span class="keywordflow">if</span> (block != 0 &amp;&amp; block %    50 == 0) { fprintf(stderr, <span class="stringliteral">&quot;.&quot;</span>); }   <span class="comment">/* Approx. 1 minute */</span>
<a name="l00144"></a>00144         <span class="comment">/*if (block != 0 &amp;&amp; block %  3000 == 0) { fprintf(stderr, &quot;|\n&quot;); }     */</span>          <span class="comment">/* Approx. 1 hour */</span>
<a name="l00145"></a>00145         <span class="comment">/*if (block != 0 &amp;&amp; block % 72000 == 0) { fprintf(stderr, &quot;===\n&quot;); }   */</span>          <span class="comment">/* Approx. 1 day */</span>
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <span class="comment">/* Read the next block */</span>
<a name="l00148"></a>00148         numSamples = <a class="code" href="group__reader.html#ga1f48311f47268ee9532cbe9961bbcf18" title="Reads the next block of data from the binary file.">OmReaderNextBlock</a>(reader);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         <span class="comment">/* Successful end of file */</span>
<a name="l00151"></a>00151         <span class="keywordflow">if</span> (numSamples == <a class="code" href="group__return__codes.html#gaa1ec7826762c2fe2c863363e3ac8c550" title="Return code: Unspecified failure.">OM_E_FAIL</a>) { <span class="keywordflow">break</span>; }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="comment">/* Problem reading the file */</span>
<a name="l00154"></a>00154         <span class="keywordflow">if</span> (numSamples &lt; 0)
<a name="l00155"></a>00155         {
<a name="l00156"></a>00156             fprintf(stderr, <span class="stringliteral">&quot;[ERROR: %d - %s]\n&quot;</span>, numSamples, <a class="code" href="group__return__codes.html#gacf8cd8926d77b109158af0b72f38f166" title="Returns an error string for the specified API return code.">OmErrorString</a>(numSamples)); 
<a name="l00157"></a>00157             errorFile++;
<a name="l00158"></a>00158             <span class="keywordflow">break</span>;
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         <span class="comment">/* Block has no valid data */</span>
<a name="l00162"></a>00162         <span class="keywordflow">if</span> (numSamples == 0)
<a name="l00163"></a>00163         {
<a name="l00164"></a>00164             fprintf(stderr, <span class="stringliteral">&quot;[WARNING: Missing packet -- probably checksum failed?]\n&quot;</span>); 
<a name="l00165"></a>00165             errorFile++;
<a name="l00166"></a>00166             <span class="keywordflow">continue</span>;
<a name="l00167"></a>00167         }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169         <span class="comment">/* Get the raw packet handle */</span>
<a name="l00170"></a>00170         dp = <a class="code" href="group__reader.html#ga8ab9d544730fc97372a1b9dee3f5409e" title="Accesses the contents of a raw data packet.">OmReaderRawDataPacket</a>(reader);
<a name="l00171"></a>00171         <span class="keywordflow">if</span> (dp == NULL)
<a name="l00172"></a>00172         {
<a name="l00173"></a>00173             fprintf(stderr, <span class="stringliteral">&quot;[ERROR: Cannot get raw data packet]\n&quot;</span>); 
<a name="l00174"></a>00174             errorFile++;
<a name="l00175"></a>00175             <span class="keywordflow">continue</span>;
<a name="l00176"></a>00176         }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="comment">/* Check events mask */</span>
<a name="l00179"></a>00179         <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___d_a_t_a___p_a_c_k_e_t.html#a6afb9ac2ccc07c1c5c4adb0ba40fe303" title="@22 +1 Event flags since last packet, b0 = resume logging, b1 = single-tap event, b2 = double-tap eve...">events</a> &amp; 0xf0)
<a name="l00180"></a>00180         {
<a name="l00181"></a>00181             fprintf(stderr, <span class="stringliteral">&quot;[EVENT-ERROR: 0x%02x]\n&quot;</span>, dp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___d_a_t_a___p_a_c_k_e_t.html#a6afb9ac2ccc07c1c5c4adb0ba40fe303" title="@22 +1 Event flags since last packet, b0 = resume logging, b1 = single-tap event, b2 = double-tap eve...">events</a>); 
<a name="l00182"></a>00182             errorEvent++;
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         <span class="comment">// Read the block start time</span>
<a name="l00186"></a>00186         {
<a name="l00187"></a>00187             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestamp;
<a name="l00188"></a>00188             <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> fractional;
<a name="l00189"></a>00189             timestamp = <a class="code" href="group__reader.html#gab8ee286a10180901a40d65647c2735e5" title="Determines the timestamp of the specified sample in the buffer read by OmReaderNextBlock().">OmReaderTimestamp</a>(reader, 0, &amp;fractional);
<a name="l00190"></a>00190             blockStart = <a class="code" href="verify_8c.html#ae705da34ceec812b223d4777b6b5088d">Ticks</a>(timestamp, fractional);
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         {
<a name="l00194"></a>00194             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> light = <a class="code" href="group__reader.html#ga46fddf401761dff1fd0976daf55c5df9" title="Returns a specific value type from the buffer read by OmReaderNextBlock().">OmReaderGetValue</a>(reader, <a class="code" href="group__reader.html#ggaa204b05abde6d663dd69cfc3d991221aad9b82ee2308aed3bac11bc14ad228386" title="Raw light sensor reading.">OM_VALUE_LIGHT</a>);
<a name="l00195"></a>00195             <span class="keywordflow">if</span> (light &lt; minLight) { minLight = light; }
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="comment">/*</span>
<a name="l00199"></a>00199 <span class="comment">        fprintf(stderr, &quot;\n[timestampOffset %04d-%02d-%02d %02d:%02d:%02d %+d * %.3f]&quot;, </span>
<a name="l00200"></a>00200 <span class="comment">            OM_DATETIME_YEAR(timestamp), OM_DATETIME_MONTH(timestamp), OM_DATETIME_DAY(timestamp),</span>
<a name="l00201"></a>00201 <span class="comment">            OM_DATETIME_HOURS(timestamp), OM_DATETIME_MINUTES(timestamp), OM_DATETIME_SECONDS(timestamp),</span>
<a name="l00202"></a>00202 <span class="comment">            -timestampOffset, 1.0f / sampleRate);</span>
<a name="l00203"></a>00203 <span class="comment">            */</span>
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         <span class="comment">// If we read a block out-of-sequence</span>
<a name="l00206"></a>00206         <span class="keywordflow">if</span> (previousSequenceId != (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)-1 &amp;&amp; previousSequenceId + 1 != dp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___d_a_t_a___p_a_c_k_e_t.html#a265f19061707d45f04e154c7a8fc1334" title="@10 +4 Sequence counter, each packet has a new number (reset if restarted)">sequenceId</a>)
<a name="l00207"></a>00207         {
<a name="l00208"></a>00208             <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___d_a_t_a___p_a_c_k_e_t.html#a265f19061707d45f04e154c7a8fc1334" title="@10 +4 Sequence counter, each packet has a new number (reset if restarted)">sequenceId</a> != 0)
<a name="l00209"></a>00209             {
<a name="l00210"></a>00210                 fprintf(stderr, <span class="stringliteral">&quot;WARNING: Sequence break %u -&gt; %u\n&quot;</span>, previousSequenceId, dp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___d_a_t_a___p_a_c_k_e_t.html#a265f19061707d45f04e154c7a8fc1334" title="@10 +4 Sequence counter, each packet has a new number (reset if restarted)">sequenceId</a>);
<a name="l00211"></a>00211             }
<a name="l00212"></a>00212             <span class="keywordflow">else</span>
<a name="l00213"></a>00213             {
<a name="l00214"></a>00214                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> recordingLength = (<span class="keywordtype">long</span> long)(lastTime - firstTime);
<a name="l00215"></a>00215                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> diff = (<span class="keywordtype">long</span> long)(blockStart - previousBlockEnd);
<a name="l00216"></a>00216                 fprintf(stderr, <span class="stringliteral">&quot;NOTE: Recording sequence restarted @%u, length of %+.2fs (gap of %+.2fs)\n&quot;</span>, previousSequenceId, (<span class="keywordtype">float</span>)recordingLength / 65536.0f, (<span class="keywordtype">float</span>)diff / 65536.0f);
<a name="l00217"></a>00217                 restarts++;
<a name="l00218"></a>00218                 totalDuration += recordingLength;
<a name="l00219"></a>00219                 breakTime += (float)diff / 65536.0f;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221                 lastBlockStart = 0;
<a name="l00222"></a>00222                 firstPacket = 1;
<a name="l00223"></a>00223                 lastSecond = -1;
<a name="l00224"></a>00224                 firstTime = 0;           <span class="comment">// Start of a new block</span>
<a name="l00225"></a>00225             }
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (firstTime == 0)
<a name="l00229"></a>00229         {
<a name="l00230"></a>00230             firstTime = blockStart;
<a name="l00231"></a>00231             <span class="keywordflow">if</span> (veryFirstTime == 0) { veryFirstTime = firstTime; }
<a name="l00232"></a>00232             lastTime = firstTime;
<a name="l00233"></a>00233             batteryStartPercent = <a class="code" href="group__reader.html#ga46fddf401761dff1fd0976daf55c5df9" title="Returns a specific value type from the buffer read by OmReaderNextBlock().">OmReaderGetValue</a>(reader, OM_VALUE_BATTERY_PERCENT);
<a name="l00234"></a>00234             batteryEndPercent = batteryStartPercent;
<a name="l00235"></a>00235             <span class="keywordflow">if</span> (batteryMaxPercent &lt; 0) { batteryMaxPercent = batteryStartPercent; }
<a name="l00236"></a>00236             <span class="keywordflow">if</span> (batteryMinPercent &lt; 0) { batteryMinPercent = batteryStartPercent; }
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         <span class="keywordflow">if</span> (lastBlockStart &gt; 0)
<a name="l00240"></a>00240         {
<a name="l00241"></a>00241             <span class="comment">// Interval</span>
<a name="l00242"></a>00242             interval = blockStart - lastBlockStart;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244             <span class="comment">// If the previous block&#39;s &quot;blockEnd&quot; is not close (+- 5%) to this block&#39;s &quot;blockStart&quot;, we have a time discontinuity</span>
<a name="l00245"></a>00245             <span class="keywordflow">if</span> (previousBlockEnd != 0 &amp;&amp; blockStart != 0 &amp;&amp; abs((<span class="keywordtype">int</span>)(previousBlockEnd - blockStart)) &gt;= 5000)
<a name="l00246"></a>00246             {
<a name="l00247"></a>00247                 <span class="keywordtype">long</span> <span class="keywordtype">long</span> diff = (<span class="keywordtype">long</span> long)(blockStart - previousBlockEnd);
<a name="l00248"></a>00248                 fprintf(stderr, <span class="stringliteral">&quot;WARNING: Time break in sequence by %+.2f seconds (last: %f, curr: %f)\n&quot;</span>, (<span class="keywordtype">float</span>)diff / 65536.0f, lastBlockStart / 65536.0f, blockStart / 65536.0f);
<a name="l00249"></a>00249                 fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00250"></a>00250                 breakTime += (float)diff / 65536.0f;
<a name="l00251"></a>00251             }
<a name="l00252"></a>00252             <span class="keywordflow">else</span>
<a name="l00253"></a>00253             {
<a name="l00254"></a>00254                 <span class="comment">// Min/max interval</span>
<a name="l00255"></a>00255                 <span class="keywordflow">if</span> (first) { first = 0; minInterval = interval; maxInterval = interval; }
<a name="l00256"></a>00256                 <span class="keywordflow">if</span> (interval &gt; maxInterval) { maxInterval = interval; }
<a name="l00257"></a>00257                 <span class="keywordflow">if</span> (interval &lt; minInterval) { minInterval = interval; }
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         lastBlockStart = blockStart;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263         buffer = <a class="code" href="group__reader.html#ga68ef443d4bad40afb7f52bc9f5bb0f71" title="Obtains a pointer to the buffer of samples read, and unpacked, by OmReaderNextBlock().">OmReaderBuffer</a>(reader);
<a name="l00264"></a>00264         <span class="keywordflow">for</span> (i = 0; i &lt; numSamples; i++)
<a name="l00265"></a>00265         {
<a name="l00266"></a>00266             <a class="code" href="group__datetime.html#ga5ae96407571b49c6086be47907389dfc" title="A single integer value is used to pack the date/time for a simpler, cross-language, API.">OM_DATETIME</a> dateTime;
<a name="l00267"></a>00267             <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> fractional;
<a name="l00268"></a>00268             <span class="keywordtype">short</span> x, y, z;
<a name="l00269"></a>00269             <span class="keyword">static</span> <span class="keywordtype">short</span> lx = 0, ly = 0, lz = 0, stuck = 0;
<a name="l00270"></a>00270             <span class="keyword">static</span> <span class="keywordtype">char</span> timeString[25];  <span class="comment">/* &quot;YYYY-MM-DD hh:mm:ss.000&quot;; */</span>
<a name="l00271"></a>00271             <span class="keyword">static</span> <span class="keywordtype">int</span> seconds, packetCount = 0;
<a name="l00272"></a>00272             <span class="keywordtype">double</span> v;
<a name="l00273"></a>00273             <span class="keyword">static</span> <span class="keywordtype">double</span> av = 0.0;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275             totalSamples++;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277             <span class="comment">/* Get the date/time value for this sample, and the 1/65536th fractions of a second */</span>
<a name="l00278"></a>00278             dateTime = <a class="code" href="group__reader.html#gab8ee286a10180901a40d65647c2735e5" title="Determines the timestamp of the specified sample in the buffer read by OmReaderNextBlock().">OmReaderTimestamp</a>(reader, i, &amp;fractional);
<a name="l00279"></a>00279             sprintf(timeString, <span class="stringliteral">&quot;%04d-%02d-%02d %02d:%02d:%02d.%03d&quot;</span>, 
<a name="l00280"></a>00280                     <a class="code" href="group__datetime.html#ga3889bada708d70fdae157d910771230b" title="Extract the year from a packed date/time value.">OM_DATETIME_YEAR</a>(dateTime), <a class="code" href="group__datetime.html#gaf4d3426bec2f1ac9dbce0965c7f6f7c8" title="Extract the month (1-12) from a packed date/time value.">OM_DATETIME_MONTH</a>(dateTime), <a class="code" href="group__datetime.html#ga09d645a3f7989b65fcc9e9c045c8798a" title="Extract the day (1-31) from a packed date/time value.">OM_DATETIME_DAY</a>(dateTime), 
<a name="l00281"></a>00281                     <a class="code" href="group__datetime.html#gae5d26861be6dc34e6f369496a8f87252" title="Extract the hours (0-23) from a packed date/time value.">OM_DATETIME_HOURS</a>(dateTime), <a class="code" href="group__datetime.html#ga6fd03816bcc340df126d7e77f02a7233" title="Extract the minutes (0-59) from a packed date/time value.">OM_DATETIME_MINUTES</a>(dateTime), <a class="code" href="group__datetime.html#gaf89fa3e164311c43b62cf12297a38dbd" title="Extract the seconds (0-59) from a packed date/time value.">OM_DATETIME_SECONDS</a>(dateTime), 
<a name="l00282"></a>00282                     (<span class="keywordtype">int</span>)fractional * 1000 / 0xffff);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284             <span class="comment">/* Get the x/y/z/ values */</span>
<a name="l00285"></a>00285             x = buffer[3 * i + 0];
<a name="l00286"></a>00286             y = buffer[3 * i + 1];
<a name="l00287"></a>00287             z = buffer[3 * i + 2];
<a name="l00288"></a>00288 
<a name="l00289"></a>00289             <span class="comment">/* Detect stuck values */</span>
<a name="l00290"></a>00290             <span class="keywordflow">if</span> (x == lx &amp;&amp; y == ly &amp;&amp; z == lz)
<a name="l00291"></a>00291             { 
<a name="l00292"></a>00292                 stuck++;
<a name="l00293"></a>00293                 <span class="keywordflow">if</span> (stuck == <a class="code" href="verify_8c.html#a080ac2194de86d8acfc23706d1c7d9de">STUCK_COUNT</a>)
<a name="l00294"></a>00294                 {
<a name="l00295"></a>00295                     fprintf(stderr, <span class="stringliteral">&quot;\nERROR: Readings could be stuck at (%d, %d, %d); has been for %d consecutive readings. &quot;</span>, lx, ly, lz, stuck);
<a name="l00296"></a>00296                     errorStuck++;
<a name="l00297"></a>00297                 }
<a name="l00298"></a>00298             }
<a name="l00299"></a>00299             <span class="keywordflow">else</span>
<a name="l00300"></a>00300             {
<a name="l00301"></a>00301                 <span class="keywordflow">if</span> (stuck &gt;= <a class="code" href="verify_8c.html#a080ac2194de86d8acfc23706d1c7d9de">STUCK_COUNT</a>)
<a name="l00302"></a>00302                 {
<a name="l00303"></a>00303                     fprintf(stderr, <span class="stringliteral">&quot;\nNOTE: Readings now changed -- were at (%d, %d, %d) for total of %d consecutive readings. &quot;</span>, lx, ly, lz, stuck);
<a name="l00304"></a>00304                 }
<a name="l00305"></a>00305                 lx = x; ly = y; lz = z;
<a name="l00306"></a>00306                 stuck = 0;
<a name="l00307"></a>00307             }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309             <span class="comment">/* Get the SVM - 1 */</span>
<a name="l00310"></a>00310             v = sqrt((x / 256.0) * (x / 256.0) + (y / 256.0) * (y / 256.0) + (z / 256.0) * (z / 256.0)) - 1.0;
<a name="l00311"></a>00311             av = ((1.0 - <a class="code" href="verify_8c.html#a489b573f8657cc4a892f86b80c1aa608">AVERAGE_FACTOR</a>) * av) + (<a class="code" href="verify_8c.html#a489b573f8657cc4a892f86b80c1aa608">AVERAGE_FACTOR</a> * v);
<a name="l00312"></a>00312             <span class="keywordflow">if</span> (fabs(av) &gt; peakAv) { peakAv = fabs(av); }
<a name="l00313"></a>00313             <span class="keywordflow">if</span> (fabs(av) &gt; maxAv) { maxAv = fabs(av); }
<a name="l00314"></a>00314             <span class="keywordflow">if</span> (fabs(av) &gt; <a class="code" href="verify_8c.html#a487b6057583dc10b18e976efacbe9edd">AVERAGE_RANGE_MAX</a>)
<a name="l00315"></a>00315             {
<a name="l00316"></a>00316                 <span class="keywordflow">if</span> (!outOfRange)
<a name="l00317"></a>00317                 {
<a name="l00318"></a>00318                     errorRange++;
<a name="l00319"></a>00319                     outOfRange = 1;
<a name="l00320"></a>00320                     peakAv = fabs(av);
<a name="l00321"></a>00321                     fprintf(stderr, <span class="stringliteral">&quot;WARNING: Average SVM gone out-of-normal-range abs(avg(svm-1)): %0.3f\n&quot;</span>, fabs(av));
<a name="l00322"></a>00322                 }
<a name="l00323"></a>00323             } 
<a name="l00324"></a>00324             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fabs(av) &lt; <a class="code" href="verify_8c.html#ac5b01ce406ab803b55eb603ed5416aff">AVERAGE_RANGE_OFF</a> &amp;&amp; outOfRange) 
<a name="l00325"></a>00325             { 
<a name="l00326"></a>00326                 outOfRange = 0; 
<a name="l00327"></a>00327                 fprintf(stderr, <span class="stringliteral">&quot;WARNING: Average SVM back in normal range, peak was abs(avg(svm-1)): %0.3f\n&quot;</span>, peakAv);
<a name="l00328"></a>00328             }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330             <span class="comment">/* Output the data */</span>
<a name="l00331"></a>00331             <span class="keywordflow">if</span> (output) { fprintf(stdout, <span class="stringliteral">&quot;%s,%d,%d,%d\n&quot;</span>, timeString, x, y, z); }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333             {
<a name="l00334"></a>00334                 <span class="keyword">static</span> <span class="keywordtype">int</span> lastHour = -1;
<a name="l00335"></a>00335                 <span class="keywordtype">int</span> hour = <a class="code" href="group__datetime.html#gae5d26861be6dc34e6f369496a8f87252" title="Extract the hours (0-23) from a packed date/time value.">OM_DATETIME_HOURS</a>(dateTime);
<a name="l00336"></a>00336                 <span class="keywordflow">if</span> (hour != lastHour)
<a name="l00337"></a>00337                 {
<a name="l00338"></a>00338                     fprintf(stderr, <span class="stringliteral">&quot;\n%02d-%02d %02d:%02d:%02d.%02d&quot;</span>, <span class="comment">/*OM_DATETIME_YEAR(dateTime) % 100, */</span> <a class="code" href="group__datetime.html#gaf4d3426bec2f1ac9dbce0965c7f6f7c8" title="Extract the month (1-12) from a packed date/time value.">OM_DATETIME_MONTH</a>(dateTime), <a class="code" href="group__datetime.html#ga09d645a3f7989b65fcc9e9c045c8798a" title="Extract the day (1-31) from a packed date/time value.">OM_DATETIME_DAY</a>(dateTime), <a class="code" href="group__datetime.html#gae5d26861be6dc34e6f369496a8f87252" title="Extract the hours (0-23) from a packed date/time value.">OM_DATETIME_HOURS</a>(dateTime), <a class="code" href="group__datetime.html#ga6fd03816bcc340df126d7e77f02a7233" title="Extract the minutes (0-59) from a packed date/time value.">OM_DATETIME_MINUTES</a>(dateTime), <a class="code" href="group__datetime.html#gaf89fa3e164311c43b62cf12297a38dbd" title="Extract the seconds (0-59) from a packed date/time value.">OM_DATETIME_SECONDS</a>(dateTime), (<span class="keywordtype">int</span>)fractional * 100 / 0xffff);
<a name="l00339"></a>00339                     lastHour = hour;
<a name="l00340"></a>00340                 }
<a name="l00341"></a>00341             }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343             seconds = <a class="code" href="group__datetime.html#gaf89fa3e164311c43b62cf12297a38dbd" title="Extract the seconds (0-59) from a packed date/time value.">OM_DATETIME_SECONDS</a>(dateTime);
<a name="l00344"></a>00344             <span class="keywordflow">if</span> (lastSecond == -1) { lastSecond = seconds; };
<a name="l00345"></a>00345             <span class="keywordflow">if</span> (seconds != lastSecond)
<a name="l00346"></a>00346             {
<a name="l00347"></a>00347                 <span class="keywordflow">if</span> (firstPacket) { <span class="comment">/* fprintf(stderr, &quot;!&quot;); */</span> firstPacket = 0; }
<a name="l00348"></a>00348                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (packetCount &gt;= 90 &amp;&amp; packetCount &lt;= 110) { <span class="comment">/* fprintf(stderr, &quot;#&quot;); */</span> }
<a name="l00349"></a>00349                 <span class="keywordflow">else</span>
<a name="l00350"></a>00350                 { 
<a name="l00351"></a>00351                     <span class="keywordflow">if</span> (seconds == lastSecond + 1 || (seconds == 0 &amp;&amp; lastSecond == 59))
<a name="l00352"></a>00352                     {
<a name="l00353"></a>00353                         errorRate++;
<a name="l00354"></a>00354                         fprintf(stderr, <span class="stringliteral">&quot;WARNING: &#39;Out of range&#39; %d samples in second :%02d before %s]\n&quot;</span>, packetCount, lastSecond, timeString);
<a name="l00355"></a>00355                     }
<a name="l00356"></a>00356                     <span class="keywordflow">else</span>
<a name="l00357"></a>00357                     {
<a name="l00358"></a>00358                         errorBreaks++;
<a name="l00359"></a>00359                         fprintf(stderr, <span class="stringliteral">&quot;WARNING: Non-sequential second jump (%d samples in second :%02d before %s)]\n&quot;</span>, packetCount, lastSecond, timeString);
<a name="l00360"></a>00360                     }
<a name="l00361"></a>00361                 }
<a name="l00362"></a>00362                 lastSecond = seconds;
<a name="l00363"></a>00363                 packetCount = 0;
<a name="l00364"></a>00364             }
<a name="l00365"></a>00365             packetCount++;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <span class="comment">// Store the current sequence id</span>
<a name="l00370"></a>00370         previousSequenceId = dp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___d_a_t_a___p_a_c_k_e_t.html#a265f19061707d45f04e154c7a8fc1334" title="@10 +4 Sequence counter, each packet has a new number (reset if restarted)">sequenceId</a>;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="comment">// Read the block end time</span>
<a name="l00373"></a>00373         {
<a name="l00374"></a>00374             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestamp;
<a name="l00375"></a>00375             <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> fractional;
<a name="l00376"></a>00376             timestamp = <a class="code" href="group__reader.html#gab8ee286a10180901a40d65647c2735e5" title="Determines the timestamp of the specified sample in the buffer read by OmReaderNextBlock().">OmReaderTimestamp</a>(reader, numSamples, &amp;fractional);
<a name="l00377"></a>00377             previousBlockEnd = <a class="code" href="verify_8c.html#ae705da34ceec812b223d4777b6b5088d">Ticks</a>(timestamp, fractional);
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         lastTime = previousBlockEnd;
<a name="l00381"></a>00381         batteryEndPercent = <a class="code" href="group__reader.html#ga46fddf401761dff1fd0976daf55c5df9" title="Returns a specific value type from the buffer read by OmReaderNextBlock().">OmReaderGetValue</a>(reader, OM_VALUE_BATTERY_PERCENT);
<a name="l00382"></a>00382         <span class="keywordflow">if</span> (batteryEndPercent &gt; batteryMaxPercent) { batteryMaxPercent = batteryEndPercent; }
<a name="l00383"></a>00383         <span class="keywordflow">if</span> (batteryEndPercent &lt; batteryMinPercent) { batteryMinPercent = batteryEndPercent; }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="comment">/* Last session&#39;s duration */</span>
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389         <span class="keywordtype">long</span> <span class="keywordtype">long</span> recordingLength = (<span class="keywordtype">long</span> long)(lastTime - firstTime);
<a name="l00390"></a>00390         totalDuration += recordingLength;
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     <span class="comment">/* Summary */</span>
<a name="l00394"></a>00394     {
<a name="l00395"></a>00395         <span class="keywordtype">int</span> startStopFail = 0;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         hp = <a class="code" href="group__reader.html#ga616368cf0b2303d56d7c1406e7aaff47" title="Accesses the contents of a raw header packet.">OmReaderRawHeaderPacket</a>(reader);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="keywordflow">if</span> (hp == NULL)
<a name="l00402"></a>00402         {
<a name="l00403"></a>00403             fprintf(stderr, <span class="stringliteral">&quot;ERROR: Unable to access file header for start/stop times.\n&quot;</span>);
<a name="l00404"></a>00404         }
<a name="l00405"></a>00405         <span class="keywordflow">else</span>
<a name="l00406"></a>00406         {
<a name="l00407"></a>00407             <span class="keywordflow">if</span> (hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a1f49c52e8909c794bc93f53e65db0b34" title="@13 +4 Start time for delayed logging">loggingStartTime</a> &gt;= <a class="code" href="group__datetime.html#ga8316c5d8a510e084722b53694cb804a7" title="The minimum valid date/time value.">OM_DATETIME_MIN_VALID</a> &amp;&amp; hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a1f49c52e8909c794bc93f53e65db0b34" title="@13 +4 Start time for delayed logging">loggingStartTime</a> &lt;= <a class="code" href="group__datetime.html#ga48430ffa6f1834e1e2f148edf1c2d4de" title="The maximum valid date/time value.">OM_DATETIME_MAX_VALID</a> &amp;&amp; hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a071d790190e81b84380c397dabe0a2aa" title="@17 +4 Stop time for delayed logging">loggingEndTime</a> &gt; hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a1f49c52e8909c794bc93f53e65db0b34" title="@13 +4 Start time for delayed logging">loggingStartTime</a>)
<a name="l00408"></a>00408             {
<a name="l00409"></a>00409                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> fStart = (<span class="keywordtype">unsigned</span> long)<a class="code" href="verify_8c.html#a28dd9d5ca8831cc4ddec9b135aba4505">TimeSerial</a>(hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a1f49c52e8909c794bc93f53e65db0b34" title="@13 +4 Start time for delayed logging">loggingStartTime</a>);
<a name="l00410"></a>00410                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> aStart = (<span class="keywordtype">unsigned</span> long)(veryFirstTime &gt;&gt; 16);
<a name="l00411"></a>00411                 <span class="keywordtype">int</span> startDiff = (int)(aStart - fStart);
<a name="l00412"></a>00412                 <span class="keywordflow">if</span> (abs(startDiff) &lt; 80)
<a name="l00413"></a>00413                 { 
<a name="l00414"></a>00414                     fprintf(stderr, <span class="stringliteral">&quot;NOTE: Data started near recording start time (%ds).\n&quot;</span>, startDiff);
<a name="l00415"></a>00415                 }
<a name="l00416"></a>00416                 <span class="keywordflow">else</span>
<a name="l00417"></a>00417                 {
<a name="l00418"></a>00418                     fprintf(stderr, <span class="stringliteral">&quot;ERROR: Data did not start near recording start time (%ds).\n&quot;</span>, startDiff);
<a name="l00419"></a>00419                     startStopFail += 2;
<a name="l00420"></a>00420                 }
<a name="l00421"></a>00421             }
<a name="l00422"></a>00422             <span class="keywordflow">else</span>
<a name="l00423"></a>00423             {
<a name="l00424"></a>00424                 fprintf(stderr, <span class="stringliteral">&quot;NOTE: Recording has no start time (not verifying).\n&quot;</span>);
<a name="l00425"></a>00425             }
<a name="l00426"></a>00426             
<a name="l00427"></a>00427             
<a name="l00428"></a>00428             <span class="keywordflow">if</span> (hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a071d790190e81b84380c397dabe0a2aa" title="@17 +4 Stop time for delayed logging">loggingEndTime</a> &gt;= <a class="code" href="group__datetime.html#ga8316c5d8a510e084722b53694cb804a7" title="The minimum valid date/time value.">OM_DATETIME_MIN_VALID</a> &amp;&amp; hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a071d790190e81b84380c397dabe0a2aa" title="@17 +4 Stop time for delayed logging">loggingEndTime</a> &lt;= <a class="code" href="group__datetime.html#ga48430ffa6f1834e1e2f148edf1c2d4de" title="The maximum valid date/time value.">OM_DATETIME_MAX_VALID</a> &amp;&amp; hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a1f49c52e8909c794bc93f53e65db0b34" title="@13 +4 Start time for delayed logging">loggingStartTime</a> &lt; hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a071d790190e81b84380c397dabe0a2aa" title="@17 +4 Stop time for delayed logging">loggingEndTime</a>)
<a name="l00429"></a>00429             {
<a name="l00430"></a>00430                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> fEnd = (<span class="keywordtype">unsigned</span> long)<a class="code" href="verify_8c.html#a28dd9d5ca8831cc4ddec9b135aba4505">TimeSerial</a>(hp-&gt;<a class="code" href="struct_o_m___r_e_a_d_e_r___h_e_a_d_e_r___p_a_c_k_e_t.html#a071d790190e81b84380c397dabe0a2aa" title="@17 +4 Stop time for delayed logging">loggingEndTime</a>);
<a name="l00431"></a>00431                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> aEnd = (<span class="keywordtype">unsigned</span> long)(lastTime &gt;&gt; 16);
<a name="l00432"></a>00432                 <span class="keywordtype">int</span> stopDiff = (int)(aEnd - fEnd);
<a name="l00433"></a>00433                 <span class="keywordflow">if</span> (abs(stopDiff) &lt; 80)
<a name="l00434"></a>00434                 { 
<a name="l00435"></a>00435                     fprintf(stderr, <span class="stringliteral">&quot;NOTE: Data stopped near recording stop time (%ds).\n&quot;</span>, stopDiff);
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437                 <span class="keywordflow">else</span>
<a name="l00438"></a>00438                 {
<a name="l00439"></a>00439                     fprintf(stderr, <span class="stringliteral">&quot;ERROR: Data did not stop near recording stop time (%ds).\n&quot;</span>, stopDiff);
<a name="l00440"></a>00440                     startStopFail += 1;
<a name="l00441"></a>00441                 }
<a name="l00442"></a>00442             }
<a name="l00443"></a>00443             <span class="keywordflow">else</span>
<a name="l00444"></a>00444             {
<a name="l00445"></a>00445                 fprintf(stderr, <span class="stringliteral">&quot;NOTE: Recording has no stop time (not verifying).\n&quot;</span>);
<a name="l00446"></a>00446             }
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         fprintf(stderr, <span class="stringliteral">&quot;---\n&quot;</span>);
<a name="l00450"></a>00450         fprintf(stderr, <span class="stringliteral">&quot;Input file: \&quot;%s\&quot;\n&quot;</span>, infile);
<a name="l00451"></a>00451         fprintf(stderr, <span class="stringliteral">&quot;Summary errors: file=%d, event=%d, stuck=%d, range=%d, rate=%d, breaks=%d\n&quot;</span>, errorFile, errorEvent, errorStuck, errorRange, errorRate, errorBreaks);
<a name="l00452"></a>00452         fprintf(stderr, <span class="stringliteral">&quot;Summary info-1: restart=%d, breakTime=%0.1fs, maxAv=%f\n&quot;</span>, restarts, breakTime, maxAv);
<a name="l00453"></a>00453         fprintf(stderr, <span class="stringliteral">&quot;Summary info-2: minInterval=%0.3f, maxInterval=%0.3f, duration=%0.4fh\n&quot;</span>, minInterval / 65536.0f, maxInterval / 65536.0f, ((totalDuration &gt;&gt; 16) / 60.0f / 60.0f));
<a name="l00454"></a>00454         fprintf(stderr, <span class="stringliteral">&quot;Summary info-3: minLight=%d, Bmax=%d%%, Bmin=%d%%, intervalFail=%d\n&quot;</span>, minLight, batteryMaxPercent, batteryMinPercent, startStopFail);
<a name="l00455"></a>00455         fprintf(stderr, <span class="stringliteral">&quot;---\n&quot;</span>);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 <span class="preprocessor">#define HEADER          &quot;filename,      file,      event,      stuck,      range,      rate,      breaks, restarts, breakTime, maxAv, minInterval,            maxInterval,                   duration,                         minLight, batteryMaxPercent, batteryMinPercent,  intervalFail\n&quot;</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span>        fprintf(stdout, <span class="stringliteral">&quot;  \&quot;%s\&quot;,        %d,         %d,         %d,         %d,        %d,          %d,       %d,     %0.1f, %0.4f,       %0.3f,                  %0.3f,                      %0.4f,                               %d,                %d,                %d,            %d\n&quot;</span>,
<a name="l00459"></a>00459                            infile, errorFile, errorEvent, errorStuck, errorRange, errorRate, errorBreaks, restarts, breakTime, maxAv, minInterval / 65536.0f, maxInterval / 65536.0f, ((totalDuration &gt;&gt; 16) / 60.0f / 60.0f), minLight, batteryMaxPercent, batteryMinPercent, startStopFail);
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <span class="comment">/* Close the files */</span>
<a name="l00464"></a>00464     <a class="code" href="group__reader.html#ga5b18b5c1ece6d59735788465c9731a59" title="Closes the specified reader handle.">OmReaderClose</a>(reader);
<a name="l00465"></a>00465     <span class="keywordflow">return</span> 0;
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="comment">/* Main function */</span>
<a name="l00470"></a><a class="code" href="verify_8c.html#a3648b96888a861a4f0f61a7691cbda8f">00470</a> <span class="keywordtype">int</span> <a class="code" href="main_8c.html#a3648b96888a861a4f0f61a7691cbda8f">verify_main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     fprintf(stderr, <span class="stringliteral">&quot;VERIFY: verify a specified binary data file contains sensible data.\n&quot;</span>);
<a name="l00473"></a>00473     fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00474"></a>00474     <span class="keywordflow">if</span> (argc &gt; 1)
<a name="l00475"></a>00475     {
<a name="l00476"></a>00476         <span class="keyword">const</span> <span class="keywordtype">char</span> *infile;
<a name="l00477"></a>00477         <span class="keywordtype">char</span> output = 0;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         <span class="keywordflow">if</span> (!strcmp(argv[1], <span class="stringliteral">&quot;-headeronly&quot;</span>))
<a name="l00480"></a>00480         {
<a name="l00481"></a>00481             fprintf(stdout, <a class="code" href="verify_8c.html#ab7770a7f0d95e67620ff6ed347a07a56">HEADER</a>);
<a name="l00482"></a>00482             <span class="keywordflow">return</span> -2;
<a name="l00483"></a>00483         }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485         infile = argv[1];
<a name="l00486"></a>00486         <span class="keywordflow">if</span> (argc &gt; 2 &amp;&amp; !strcmp(argv[2], <span class="stringliteral">&quot;-output&quot;</span>)) { output = 1; }
<a name="l00487"></a>00487         <span class="keywordflow">return</span> <a class="code" href="verify_8c.html#ad5ad9d8ff8c4d00cbffdca435d4c5071">verify</a>(infile, output);
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489     <span class="keywordflow">else</span>
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491         fprintf(stderr, <span class="stringliteral">&quot;Usage: verify &lt;binary-input-file | -headeronly&gt; [-output]\n&quot;</span>);
<a name="l00492"></a>00492         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00493"></a>00493         fprintf(stderr, <span class="stringliteral">&quot;Where: binary-input-file: the name of the binary file to verify.\n&quot;</span>);
<a name="l00494"></a>00494         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00495"></a>00495         fprintf(stderr, <span class="stringliteral">&quot;Example: verify data.cwa\n&quot;</span>);
<a name="l00496"></a>00496         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 <span class="preprocessor">#if defined(_WIN32) &amp;&amp; defined(_DEBUG)</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (IsDebuggerPresent()) { fprintf(stderr, <span class="stringliteral">&quot;Press [enter] to exit...&quot;</span>); getc(stdin); }
<a name="l00501"></a>00501 <span class="preprocessor">#endif</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>
<a name="l00503"></a>00503     <span class="keywordflow">return</span> -1;
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="verify_8c.html">verify.c</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer"><!-- Generated on Wed Aug 15 2012 13:56:59 for OMAPI by -->
    <a href="http://www.doxygen.org/index.html">doxygen</a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
